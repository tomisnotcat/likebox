<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LikeBox - 为喜欢的产品点赞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <nav class="bg-white shadow-sm sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                <h1 class="text-xl font-bold text-indigo-600 cursor-pointer" @click="goHome"><i class="fas fa-heart"></i> LikeBox</h1>
                <div class="flex items-center gap-3">
                    <button @click="showRanking = true; loadRanking()" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-trophy"></i></button>
                    <button @click="showProductRanking = true; loadProductRanking()" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-fire"></i></button>
                    <template v-if="currentUser">
                        <button @click="showProfile = true; loadUserData()" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-user"></i></button>
                        <span class="text-gray-600">{{ currentUser }}</span>
                        <button @click="logout" class="text-sm text-gray-500 hover:text-gray-700">退出</button>
                    </template>
                    <button v-else @click="showLogin = true" class="text-indigo-600 hover:text-indigo-800">登录</button>
                </div>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto px-4 py-6">
            <div class="mb-6 flex flex-wrap gap-3 items-center">
                <input v-model="search" @keyup.enter="loadProducts" type="text" placeholder="搜索产品..." class="px-4 py-2 border rounded-lg w-64">
                <select v-model="brandId" @change="loadProducts" class="px-4 py-2 border rounded-lg">
                    <option :value="null">全部品牌</option>
                    <option v-for="brand in brands" :key="brand.id" :value="brand.id">{{ brand.name }}</option>
                </select>
                <select v-model="categoryId" @change="loadProducts" class="px-4 py-2 border rounded-lg">
                    <option :value="null">全部分类</option>
                    <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                </select>
                <select v-model="sort" @change="loadProducts" class="px-4 py-2 border rounded-lg">
                    <option value="latest">最新</option>
                    <option value="popular">最热</option>
                </select>
                <button @click="showAddProduct = true" class="ml-auto bg-indigo-600 text-white px-4 py-2 rounded-lg">添加产品</button>
            </div>

            <div v-if="tags.length" class="mb-4 flex flex-wrap gap-2">
                <span class="text-sm text-gray-500">热门标签:</span>
                <button v-for="tag in tags" :key="tag.name" @click="searchTag(tag.name)" class="px-2 py-1 text-xs bg-gray-100 rounded-full">{{ tag.name }}</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div v-for="product in products" :key="product.id" class="bg-white rounded-xl shadow-sm overflow-hidden" @click="viewProduct(product)">
                    <div v-if="product.image_url" class="h-48 bg-gray-200 relative">
                        <img :src="product.image_url" class="w-full h-full object-cover">
                        <button @click.stop="toggleFavorite(product)" class="absolute top-2 right-2 w-8 h-8 rounded-full bg-white/80"><i class="fas fa-star" :class="product.is_favorited ? 'text-yellow-500' : 'text-gray-400'"></i></button>
                    </div>
                    <div v-else class="h-48 bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center"><i class="fas fa-box text-4xl text-indigo-300"></i></div>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg truncate">{{ product.name }}</h3>
                        <p class="text-sm text-gray-500 mt-1 line-clamp-2">{{ product.description }}</p>
                        <div class="mt-3 flex items-center justify-between">
                            <span class="text-xs text-gray-400">{{ formatDate(product.created_at) }}</span>
                            <button @click.stop="toggleLike(product)" class="flex items-center gap-1 px-3 py-1 rounded-full" :class="product.is_liked ? 'bg-red-100 text-red-600' : 'bg-gray-100'">
                                <i class="fas fa-heart" :class="product.is_liked ? 'fa-solid' : 'fa-regular'"></i> {{ product.like_count }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="showLogin" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showLogin = false">
            <div class="bg-white rounded-xl p-6 w-96">
                <h2 class="text-xl font-bold mb-4">{{ isRegister ? '注册' : '登录' }}</h2>
                <input v-model="authForm.username" type="text" placeholder="用户名" class="w-full px-4 py-2 border rounded-lg mb-3">
                <input v-model="authForm.password" type="password" placeholder="密码" class="w-full px-4 py-2 border rounded-lg mb-4" @keyup.enter="auth">
                <button @click="auth" class="w-full bg-indigo-600 text-white py-2 rounded-lg mb-3">{{ isRegister ? '注册' : '登录' }}</button>
                <p class="text-center text-sm text-gray-500">{{ isRegister ? '已有账号？' : '没有账号？' }} <a href="#" @click.prevent="isRegister = !isRegister" class="text-indigo-600">{{ isRegister ? '去登录' : '去注册' }}</a></p>
            </div>
        </div>

        <div v-if="showAddProduct" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showAddProduct = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-lg">
                <h2 class="text-xl font-bold mb-4">添加产品</h2>
                <input v-model="productForm.name" type="text" placeholder="产品名称 *" class="w-full px-4 py-2 border rounded-lg mb-3">
                <textarea v-model="productForm.description" placeholder="产品描述 *" rows="3" class="w-full px-4 py-2 border rounded-lg mb-3"></textarea>
                <input v-model="productForm.image_url" type="text" placeholder="图片URL" class="w-full px-4 py-2 border rounded-lg mb-3">
                <input v-model="productForm.product_url" type="text" placeholder="商品链接" class="w-full px-4 py-2 border rounded-lg mb-3">
                <input v-model="productForm.tags" type="text" placeholder="标签（逗号分隔）" class="w-full px-4 py-2 border rounded-lg mb-3">
                <select v-model="productForm.category_id" class="w-full px-4 py-2 border rounded-lg mb-4">
                    <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                </select>
                <div class="flex gap-3">
                    <button @click="showAddProduct = false" class="flex-1 border py-2 rounded-lg">取消</button>
                    <button @click="addProduct" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg">添加</button>
                </div>
            </div>
        </div>

        <div v-if="selectedProduct" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="selectedProduct = null">
            <div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div v-if="selectedProduct.image_url" class="h-64 bg-gray-200"><img :src="selectedProduct.image_url" class="w-full h-full object-cover"></div>
                <div class="p-6">
                    <div class="flex items-start justify-between">
                        <div><h2 class="text-2xl font-bold">{{ selectedProduct.name }}</h2><p class="text-sm text-gray-500">{{ formatDate(selectedProduct.created_at) }}</p></div>
                        <div class="flex items-center gap-2">
                            <button @click="toggleLike(selectedProduct)" class="flex items-center gap-2 px-4 py-2 rounded-full" :class="selectedProduct.is_liked ? 'bg-red-100 text-red-600' : 'bg-gray-100'">
                                <i class="fas fa-heart" :class="selectedProduct.is_liked ? 'fa-solid' : 'fa-regular'"></i> {{ selectedProduct.like_count }}
                            </button>
                        </div>
                    </div>
                    <p class="mt-4">{{ selectedProduct.description }}</p>
                    <a v-if="selectedProduct.product_url" :href="selectedProduct.product_url" target="_blank" class="mt-4 inline-flex items-center gap-2 text-indigo-600">查看商品 <i class="fas fa-external-link-alt"></i></a>
                    <div class="mt-6 border-t pt-4">
                        <h3 class="font-semibold mb-3">评论 ({{ comments.length }})</h3>
                        <div v-if="currentUser" class="mb-4 flex gap-2">
                            <input v-model="newComment" @keyup.enter="submitComment" type="text" placeholder="写评论..." class="flex-1 px-4 py-2 border rounded-lg">
                            <button @click="submitComment" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">发表</button>
                        </div>
                        <div class="space-y-3">
                            <div v-for="comment in comments" :key="comment.id" class="bg-gray-50 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-medium text-sm">{{ comment.username }}</span>
                                    <span class="text-xs text-gray-400">{{ formatDate(comment.created_at) }}</span>
                                </div>
                                <p>{{ comment.content }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showRanking" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showRanking = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold"><i class="fas fa-trophy text-yellow-500"></i> 排行榜</h2><button @click="showRanking = false"><i class="fas fa-times"></i></button></div>
                <div class="space-y-3">
                    <div v-for="(user, index) in ranking" :key="user.username" class="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
                        <span class="font-bold" :class="index === 0 ? 'text-yellow-500' : 'text-gray-500'">{{ index + 1 }}</span>
                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">{{ user.username.charAt(0).toUpperCase() }}</div>
                        <div class="flex-1"><div class="font-medium">{{ user.username }}</div><div class="text-xs text-gray-500">{{ user.product_count }} 产品 · {{ user.like_count }} 赞</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showProductRanking" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showProductRanking = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-lg">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold"><i class="fas fa-fire text-red-500"></i> 热门</h2><button @click="showProductRanking = false"><i class="fas fa-times"></i></button></div>
                <select v-model="rankingCategoryId" @change="loadProductRanking" class="w-full px-4 py-2 border rounded-lg mb-4">
                    <option :value="null">全部分类</option>
                    <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                </select>
                <div class="space-y-3">
                    <div v-for="(product, index) in productRanking" :key="product.id" class="flex items-center gap-3 p-3 rounded-lg bg-gray-50" @click="viewProduct(product); showProductRanking = false">
                        <span class="font-bold text-lg" :class="index === 0 ? 'text-yellow-500' : 'text-gray-500'">{{ index + 1 }}</span>
                        <div class="w-12 h-12 rounded-lg bg-gray-200"><img v-if="product.image_url" :src="product.image_url" class="w-full h-full object-cover rounded-lg"></div>
                        <div class="flex-1"><div class="font-medium">{{ product.name }}</div><div class="text-xs text-gray-500"><i class="fas fa-heart text-red-500"></i> {{ product.like_count }}</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showProfile" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showProfile = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold"><i class="fas fa-user text-indigo-600"></i> 个人主页</h2><button @click="showProfile = false"><i class="fas fa-times"></i></button></div>
                <div class="flex gap-2 mb-4">
                    <button @click="profileTab = 'products'" class="px-4 py-2 rounded-lg" :class="profileTab === 'products' ? 'bg-indigo-600 text-white' : 'bg-gray-100'">我的产品</button>
                    <button @click="profileTab = 'favorites'" class="px-4 py-2 rounded-lg" :class="profileTab === 'favorites' ? 'bg-indigo-600 text-white' : 'bg-gray-100'">收藏</button>
                </div>
                <div v-if="profileTab === 'products'" class="space-y-3">
                    <div v-for="product in myProducts" :key="product.id" class="flex items-center gap-3 p-3 rounded-lg bg-gray-50" @click="viewProduct(product); showProfile = false">
                        <div class="w-12 h-12 rounded-lg bg-gray-200"><img v-if="product.image_url" :src="product.image_url" class="w-full h-full object-cover rounded-lg"></div>
                        <div class="flex-1"><div class="font-medium">{{ product.name }}</div><div class="text-xs text-gray-500">{{ product.like_count }} 赞</div></div>
                    </div>
                </div>
                <div v-if="profileTab === 'favorites'" class="space-y-3">
                    <div v-for="product in myFavorites" :key="product.id" class="flex items-center gap-3 p-3 rounded-lg bg-gray-50" @click="viewProduct(product); showProfile = false">
                        <div class="w-12 h-12 rounded-lg bg-gray-200"><img v-if="product.image_url" :src="product.image_url" class="w-full h-full object-cover rounded-lg"></div>
                        <div class="flex-1"><div class="font-medium">{{ product.name }}</div><div class="text-xs text-gray-500">{{ product.like_count }} 赞</div></div>
                        <i class="fas fa-star text-yellow-500"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    currentUser: localStorage.getItem('username') || null,
                    currentUserId: null,
                    isAdmin: false,
                    products: [], categories: [], brands: [], brandId: null, comments: [], tags: [],
                    selectedProduct: null,
                    showLogin: false, showAddProduct: false, showRanking: false, showProductRanking: false, showProfile: false,
                    ranking: [], productRanking: [], myProducts: [], myFavorites: [],
                    profileTab: 'products', rankingCategoryId: null, isRegister: false,
                    search: '', categoryId: null, sort: 'latest',
                    authForm: { username: '', password: '' },
                    productForm: { name: '', description: '', image_url: '', product_url: '', tags: '', category_id: 1 },
                    newComment: ''
                }
            },
            mounted() {
                this.loadCategories();
                this.loadProducts();
                this.loadTags(); this.loadBrands();
                this.checkUser();
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('product');
                if (productId) this.loadProductById(productId);
            },
            methods: {
                async checkUser() {
                    if (!this.currentUser) return;
                    const res = await fetch('/api/user?username=' + this.currentUser);
                    const user = await res.json();
                    if (user) { this.currentUserId = user.id; this.isAdmin = user.is_admin; }
                },
                goHome() { this.selectedProduct = null; this.categoryId = null; this.search = ''; this.loadProducts(); window.history.pushState({}, '', '/'); },
                async loadCategories() { this.categories = await (await fetch('/api/categories')).json(); },
                async loadTags() { this.tags = await (await fetch('/api/tags')).json(); },
                async loadBrands() { this.brands = await (await fetch('/api/brands')).json(); },
                async loadProducts() {
                    const params = new URLSearchParams();
                    if (this.categoryId) params.append('category_id', this.categoryId);
                    if (this.brandId) params.append('brand_id', this.brandId);
                    if (this.search) params.append('search', this.search);
                    params.append('sort', this.sort);
                    if (this.currentUser) params.append('username', this.currentUser);
                    this.products = await (await fetch('/api/products?' + params)).json();
                },
                searchTag(tag) { this.search = tag; this.loadProducts(); },
                async loadProductById(id) {
                    const username = this.currentUser || '';
                    const res = await fetch('/api/products/' + id + '?username=' + username);
                    if (res.ok) { this.selectedProduct = await res.json(); this.loadComments(this.selectedProduct.id); }
                },
                async loadRanking() { this.ranking = await (await fetch('/api/ranking')).json(); },
                async loadProductRanking() {
                    const params = new URLSearchParams();
                    if (this.rankingCategoryId) params.append('category_id', this.rankingCategoryId);
                    this.productRanking = await (await fetch('/api/products/ranking?' + params)).json();
                },
                async loadUserData() {
                    if (!this.currentUser) return;
                    this.myProducts = await (await fetch('/api/user/products?username=' + this.currentUser)).json();
                    this.myFavorites = await (await fetch('/api/user/favorites?username=' + this.currentUser)).json();
                },
                async auth() {
                    const endpoint = this.isRegister ? '/api/register' : '/api/login';
                    const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.authForm) });
                    if (!res.ok) { alert((await res.json()).error); return; }
                    const data = await res.json();
                    this.currentUser = data.username; this.currentUserId = data.user_id; this.isAdmin = data.is_admin;
                    localStorage.setItem('username', this.currentUser);
                    this.showLogin = false; this.authForm = { username: '', password: '' }; this.loadProducts();
                },
                logout() { this.currentUser = null; localStorage.removeItem('username'); this.loadProducts(); },
                async addProduct() {
                    if (!this.currentUser) { alert('请先登录'); return; }
                    const res = await fetch('/api/products', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...this.productForm, username: this.currentUser }) });
                    if (res.ok) { this.showAddProduct = false; this.productForm = { name: '', description: '', image_url: '', product_url: '', tags: '', category_id: 1 }; this.loadProducts(); this.loadTags(); }
                },
                async viewProduct(product) {
                    this.selectedProduct = { ...product };
                    await this.loadComments(product.id);
                    window.history.pushState({}, '', '?product=' + product.id);
                    if (this.currentUser) fetch('/api/history', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: this.currentUser, product_id: product.id }) });
                },
                async loadComments(productId) { this.comments = await (await fetch('/api/products/' + productId + '/comments?username=' + (this.currentUser || ''))).json(); },
                async toggleLike(product) {
                    if (!this.currentUser) { this.showLogin = true; return; }
                    const res = await fetch('/api/products/' + product.id + '/like', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: this.currentUser }) });
                    const data = await res.json();
                    product.like_count = data.count; product.is_liked = data.liked;
                    if (this.selectedProduct && this.selectedProduct.id === product.id) { this.selectedProduct.like_count = data.count; this.selectedProduct.is_liked = data.liked; }
                },
                async toggleFavorite(product) {
                    if (!this.currentUser) { this.showLogin = true; return; }
                    const res = await fetch('/api/products/' + product.id + '/favorite', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: this.currentUser }) });
                    const data = await res.json();
                    product.is_favorited = data.favorited;
                    if (this.selectedProduct && this.selectedProduct.id === product.id) this.selectedProduct.is_favorited = data.favorited;
                },
                async submitComment() {
                    if (!this.newComment.trim()) return;
                    await fetch('/api/comments', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ product_id: this.selectedProduct.id, content: this.newComment, username: this.currentUser }) });
                    this.newComment = ''; this.loadComments(this.selectedProduct.id);
                },
                formatDate(dateStr) { return new Date(dateStr).toLocaleDateString('zh-CN'); }
            }
        }).mount('#app');
    </script>
</body>
</html>
