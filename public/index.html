<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="description" content="å‘ç°å¹¶åˆ†äº«ä½ å–œæ¬¢çš„äº§å“">
<meta name="keywords" content="äº§å“,ç‚¹èµ,å¥½ç‰©æ¨è,ç§è‰">
<title>LikeBox - ä¸ºå–œæ¬¢çš„äº§å“ç‚¹èµ</title>
    <meta property="og:title" content="LikeBox - äº§å“ç‚¹èµå¹³å°">
    <meta property="og:description" content="å‘ç°å¹¶åˆ†äº«ä½ å–œæ¬¢çš„äº§å“">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Dark mode */
.dark{background:#1a1a2e!important;color:#eee!important}
.dark .bg-white{background:#16213e!important;color:#eee}
.dark .text-gray-500,.dark .text-gray-400,.dark .text-gray-600,.dark .text-gray-700{color:#aaa!important}
.dark .border{border-color:#333!important}
.dark input,.dark select,.dark textarea{background:#2a2a4a;color:#eee;border-color:#444}
.dark .bg-gray-50,.dark .bg-gray-100{background:#252540!important}
.dark ::placeholder{color:#888}

/* Loading skeleton */
@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}
.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}
.dark .skeleton {
    background: linear-gradient(90deg, #2a2a4a 25%, #3a3a5a 50%, #2a2a4a 75%);
    background-size: 200% 100%;
}

/* Card hover effects */
.product-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.1);
}
.dark .product-card:hover {
    box-shadow: 0 12px 24px rgba(0,0,0,0.3);
}

/* Image overlay gradient */
.card-image-overlay {
    background: linear-gradient(to top, rgba(0,0,0,0.4) 0%, transparent 50%);
}

/* Fade in animation */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.fade-in-up {
    animation: fadeInUp 0.4s ease forwards;
}
.fade-in-up:nth-child(1) { animation-delay: 0.05s; }
.fade-in-up:nth-child(2) { animation-delay: 0.1s; }
.fade-in-up:nth-child(3) { animation-delay: 0.15s; }
.fade-in-up:nth-child(4) { animation-delay: 0.2s; }
.fade-in-up:nth-child(5) { animation-delay: 0.25s; }
.fade-in-up:nth-child(6) { animation-delay: 0.3s; }

/* Mobile touch optimizations */
@media (max-width: 768px) {
    .product-card:active {
        transform: scale(0.98);
    }
    .btn-mobile {
        min-height: 44px;
        min-width: 44px;
    }
    nav button {
        padding: 8px;
    }
    .grid {
        gap: 12px;
    }
}

/* Smooth loading spinner */
.loading-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #4f46e5;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.dark .loading-spinner {
    border-color: #3a3a5a;
    border-top-color: #4f46e5;
}

/* Like button animation */
@keyframes likePulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}
.like-animate {
    animation: likePulse 0.3s ease;
}

/* Staggered card entrance */
.product-card {
    opacity: 0;
}
.product-card.loaded {
    opacity: 1;
}
</style>
<meta name="theme-color" content="#4f46e5">
<link rel="manifest" href="/manifest.json"></head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <nav :class="{ dark: darkMode }" class="bg-white shadow-sm sticky top-0 z-50" @touchstart="touchStart" @touchend="touchEnd">
            <div class="max-w-6xl mx-auto px-2 sm:px-4 py-2 sm:py-3 flex items-center justify-between">
                <h1 class="text-lg sm:text-xl font-bold text-indigo-600 cursor-pointer px-2" @click="goHome"><i class="fas fa-heart"></i> <span class="hidden sm:inline">LikeBox</span></h1>
                <div class="flex items-center gap-1 sm:gap-3 overflow-x-auto max-w-[70%] sm:max-w-none">
                    <!-- Check-in -->
        <div v-if="showCheckin" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showCheckin = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-sm text-center">
                <div v-if="checkinStatus.checked" class="text-green-500 text-4xl mb-2"><i class="fas fa-check-circle"></i></div>
                <div v-else class="text-yellow-500 text-4xl mb-2"><i class="fas fa-gift"></i></div>
                <h2 class="text-xl font-bold mb-2">{{ checkinStatus.checked ? "ä»Šæ—¥å·²ç­¾åˆ°" : "æ¯æ—¥ç­¾åˆ°" }}</h2>
                <p class="text-gray-500 mb-4">è¿ç»­ç­¾åˆ°: {{ checkinStatus.days }} å¤©</p>
                <button v-if="!checkinStatus.checked" @click="doCheckin" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">ç­¾åˆ° +10 ç§¯åˆ†</button>
                <button v-else @click="showCheckin = false" class="w-full border py-2 rounded-lg">ç¡®å®š</button>
            </div>
        </div>

        <!-- Points -->
        <div v-if="showPoints" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showPoints = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-sm text-center">
                <h2 class="text-xl font-bold mb-4"><i class="fas fa-coins text-yellow-500"></i> æˆ‘çš„ç§¯åˆ†</h2>
                <div class="text-4xl font-bold text-indigo-600 mb-2">{{ userPoints }}</div>
                <p class="text-gray-500 mb-4">ç­‰çº§ Lv.{{ userLevel }}</p>
                <div class="text-left text-sm bg-gray-50 p-3 rounded-lg">
                    <p class="mb-1">ğŸ‘ ç‚¹èµ +1 ç§¯åˆ†</p>
                    <p class="mb-1">ğŸ’¬ è¯„è®º +2 ç§¯åˆ†</p>
                    <p class="mb-1">â• æ·»åŠ äº§å“ +5 ç§¯åˆ†</p>
                    <p class="mb-1">ğŸ“… æ¯æ—¥ç­¾åˆ° +10 ç§¯åˆ†</p>
                    <p>ğŸ“¤ åˆ†äº« +5 ç§¯åˆ†</p>
                </div>
            </div>
        </div>

        <button @click="darkMode = !darkMode; localStorage.setItem('darkMode', darkMode)" class="text-gray-600 hover:text-indigo-600 p-2 btn-mobile" :title="darkMode ? 'åˆ‡æ¢äº®è‰²æ¨¡å¼' : 'åˆ‡æ¢æš—è‰²æ¨¡å¼'"><i class="fas" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i></button>
                    <button @click="showCompare = true" class="text-gray-600 hover:text-indigo-600 p-2 btn-mobile" title="å¯¹æ¯”"><i class="fas fa-balance-scale"></i></button>
                    <button @click="showWeekly = true; loadWeekly()" class="text-gray-600 hover:text-indigo-600 p-2 btn-mobile" title="ä¸€å‘¨ç²¾é€‰"><i class="fas fa-star"></i></button>
                    <button @click="showCheckin = true; loadCheckin()" class="text-gray-600 hover:text-indigo-600 p-2 btn-mobile" title="ç­¾åˆ°"><i class="fas fa-calendar-check"></i></button>
                    <button @click="showPoints = true; loadPoints()" class="text-gray-600 hover:text-indigo-600 p-2 btn-mobile" title="ç§¯åˆ†"><i class="fas fa-coins"></i></button>
                    <button @click="showLeaderboard = true; loadLeaderboard()" class="text-gray-600 hover:text-indigo-600 p-2 btn-mobile" title="æ´»è·ƒæ¦œ"><i class="fas fa-chart-line"></i></button>
                    <button @click="showRanking = true; loadRanking()" class="text-gray-600 hover:text-indigo-600 p-2 btn-mobile" title="æ’è¡Œæ¦œ"><i class="fas fa-trophy"></i></button>
                    <button @click="showProductRanking = true; loadProductRanking()" class="text-gray-600 hover:text-indigo-600 p-2 btn-mobile" title="çƒ­é—¨"><i class="fas fa-fire"></i></button>
                    <button v-if="isAdmin" @click="showAdmin = true; loadAdminStats()" class="text-gray-600 hover:text-indigo-600 p-2 btn-mobile" title="ç®¡ç†"><i class="fas fa-cog"></i></button>
                    <template v-if="currentUser">
                        <button @click="showProfile = true; loadUserData()" class="text-gray-600 hover:text-indigo-600 p-2 btn-mobile" title="ä¸ªäººä¸­å¿ƒ"><i class="fas fa-user"></i></button>
                        <span class="text-gray-600 text-sm hidden md:inline">{{ currentUser }}</span>
                        <button @click="logout" class="text-sm text-gray-500 p-2">é€€å‡º</button>
                    </template>
                    <button v-else @click="showLogin = true" class="text-indigo-600 p-2 btn-mobile">ç™»å½•</button>
                </div>
            </div>
        </nav>

        <main class="max-w-6xl mx-auto px-4 py-6">
            <!-- Loading State -->
            <div v-if="loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div v-for="n in 6" :key="n" class="bg-white rounded-xl overflow-hidden">
                    <div class="h-48 skeleton"></div>
                    <div class="p-4 space-y-3">
                        <div class="h-6 skeleton rounded w-3/4"></div>
                        <div class="h-4 skeleton rounded w-full"></div>
                        <div class="h-4 skeleton rounded w-1/2"></div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div v-else-if="products.length === 0" class="text-center py-16">
                <div class="text-6xl mb-4">ğŸ“¦</div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">æš‚æ— äº§å“</h3>
                <p class="text-gray-500 mb-4">è¿˜æ²¡æœ‰ä»»ä½•äº§å“ï¼Œå¿«æ¥æ·»åŠ ç¬¬ä¸€ä¸ªå§ï¼</p>
                <button @click="showAddProduct = true" class="bg-indigo-600 text-white px-6 py-2 rounded-lg">æ·»åŠ äº§å“</button>
            </div>

            <!-- Brand Banner -->
            <div v-if="selectedBrand" class="mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white">
                <button @click="selectedBrand = null; brandId = null; loadProducts()" class="mb-2 text-white/80 hover:text-white"><i class="fas fa-arrow-left"></i> è¿”å›</button>
                <div class="flex items-center gap-4">
                    <img loading="lazy" v-if="selectedBrand.logo" :src="selectedBrand.logo" class="w-16 h-16 rounded-full bg-white p-1">
                    <div>
                        <h2 class="text-2xl font-bold">{{ selectedBrand.name }}</h2>
                        <p class="text-white/80">{{ selectedBrand.description }}</p>
                        <p class="text-sm mt-1">{{ selectedBrand.products?.length || 0 }} ä¸ªäº§å“</p>
                    </div>
                </div>
            </div>

            <div v-else class="mb-4 sm:mb-6 flex flex-wrap gap-2 sm:gap-3 items-center">
                <input v-model="search" @keyup.enter="loadProducts" type="text" placeholder="æœç´¢äº§å“..." class="px-3 sm:px-4 py-2 border rounded-lg w-full sm:w-48 lg:w-64 touch-manipulation">
                
                <select v-model="brandId" @change="loadBrandProducts" class="px-3 sm:px-4 py-2 border rounded-lg touch-manipulation flex-1 sm:flex-none">
                    <option :value="null">å…¨éƒ¨å“ç‰Œ</option>
                    <option v-for="brand in brands" :key="brand.id" :value="brand.id">{{ brand.name }}</option>
                </select>
                
                <select v-model="categoryId" @change="loadProducts" class="px-3 sm:px-4 py-2 border rounded-lg touch-manipulation flex-1 sm:flex-none">
                    <option :value="null">å…¨éƒ¨åˆ†ç±»</option>
                    <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                </select>
                
                <select v-model="sort" @change="loadProducts" class="px-3 sm:px-4 py-2 border rounded-lg touch-manipulation">
                    <option value="latest">æœ€æ–°</option>
                    <option value="popular">æœ€çƒ­</option>
                </select>
                
                <button @click="showAddProduct = true" class="ml-auto bg-indigo-600 text-white px-4 py-2 rounded-lg w-full sm:w-auto btn-mobile">æ·»åŠ äº§å“</button>
            </div>

            <div v-if="tags.length && !selectedBrand" class="mb-4 flex flex-wrap gap-2">
                <span class="text-sm text-gray-500">çƒ­é—¨æ ‡ç­¾:</span>
                <button v-for="tag in tags" :key="tag.name" @click="searchTag(tag.name)" class="px-2 py-1 text-xs bg-gray-100 rounded-full">{{ tag.name }}</button>
            </div>

            <!-- Compare Bar -->
            <div v-if="compareList.length > 0" class="mb-4 bg-indigo-50 rounded-lg p-3 flex items-center gap-2 flex-wrap">
                <span class="text-sm text-indigo-600">å¯¹æ¯” ({{ compareList.length }}):</span>
                <span v-for="p in compareList" :key="p.id" class="px-2 py-1 bg-white rounded text-sm flex items-center gap-1">
                    {{ p.name }}
                    <button @click="removeFromCompare(p)" class="text-red-500"><i class="fas fa-times"></i></button>
                </span>
                <button @click="compareList = []" class="text-sm text-gray-500">æ¸…ç©º</button>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                <div v-for="product in products" :key="product.id" class="product-card bg-white rounded-xl shadow-sm overflow-hidden cursor-pointer" @click="viewProduct(product)">
                    <div v-if="product.image_url" class="h-44 sm:h-48 bg-gray-200 relative overflow-hidden group" @click.stop="toggleCompare(product)">
                        <img loading="lazy" :src="product.image_url" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                        <div class="card-image-overlay absolute inset-0"></div>
                        <button @click.stop="toggleFavorite(product); $event.stopPropagation()" class="absolute top-2 right-2 w-9 h-9 rounded-full bg-white/90 backdrop-blur flex items-center justify-center hover:scale-110 transition-transform btn-mobile">
                            <i class="fas fa-star transition-colors" :class="product.is_favorited ? 'text-yellow-500' : 'text-gray-400'"></i></button>
                        <span v-if="compareList.find(p => p.id === product.id)" class="absolute top-2 left-2 w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center text-xs"><i class="fas fa-check"></i></span>
                    </div>
                    <div v-else class="h-44 sm:h-48 bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center relative overflow-hidden group" @click.stop="toggleCompare(product)">
                        <i class="fas fa-box text-4xl text-indigo-300"></i>
                        <div class="card-image-overlay absolute inset-0"></div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-lg truncate">{{ product.name }}</h3>
                        <p class="text-sm text-gray-500 mt-1 line-clamp-2">{{ product.description }}</p>
                        <div class="mt-3 flex items-center justify-between">
                            <span class="text-xs text-gray-400">{{ formatDate(product.created_at) }}</span>
                            <button @click.stop="toggleLike(product)" class="flex items-center gap-1 px-3 py-1.5 rounded-full transition-all btn-mobile" :class="product.is_liked ? 'bg-red-100 text-red-600' : 'bg-gray-100 hover:bg-gray-200'">
                                <i class="fas fa-heart transition-transform" :class="[product.is_liked ? 'fa-solid' : 'fa-regular', product.likeAnimating ? 'like-animate' : '']"></i> <span>{{ product.like_count }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Login -->
        <div v-if="showLogin" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" @click.self="showLogin = false">
            <div class="bg-white rounded-xl p-5 sm:p-6 w-full max-w-sm">
                <h2 class="text-xl font-bold mb-4">{{ isRegister ? 'æ³¨å†Œ' : 'ç™»å½•' }}</h2>
                <input v-model="authForm.username" type="text" placeholder="ç”¨æˆ·å" class="w-full px-4 py-2.5 border rounded-lg mb-3 touch-manipulation">
                <input v-model="authForm.password" type="password" placeholder="å¯†ç " class="w-full px-4 py-2.5 border rounded-lg mb-4 touch-manipulation" @keyup.enter="auth">
                <button @click="auth" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg mb-3 btn-mobile">{{ isRegister ? 'æ³¨å†Œ' : 'ç™»å½•' }}</button>
                <p class="text-center text-sm text-gray-500">{{ isRegister ? 'å·²æœ‰è´¦å·ï¼Ÿ' : 'æ²¡æœ‰è´¦å·ï¼Ÿ' }} <a href="#" @click.prevent="isRegister = !isRegister" class="text-indigo-600">{{ isRegister ? 'å»ç™»å½•' : 'å»æ³¨å†Œ' }}</a></p>
            </div>
        </div>

        <!-- Add Product -->
        <div v-if="showAddProduct" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4" @click.self="showAddProduct = false">
            <div class="bg-white rounded-xl p-4 sm:p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-bold mb-4">æ·»åŠ äº§å“</h2>
                <input v-model="productForm.name" type="text" placeholder="äº§å“åç§° *" class="w-full px-4 py-2.5 border rounded-lg mb-3 touch-manipulation">
                <textarea v-model="productForm.description" placeholder="äº§å“æè¿° *" rows="3" class="w-full px-4 py-2 border rounded-lg mb-3 touch-manipulation"></textarea>
                <div class="mb-3">
                    <label class="block text-sm text-gray-500 mb-1">äº§å“å›¾ç‰‡</label>
                    <input type="file" @change="handleImageUpload" accept="image/*" class="w-full px-4 py-2 border rounded-lg touch-manipulation">
                    <img loading="lazy" v-if="productForm.imagePreview" :src="productForm.imagePreview" class="mt-2 h-32 object-cover rounded">
                </div>
                <input v-model="productForm.product_url" type="text" placeholder="å•†å“é“¾æ¥" class="w-full px-4 py-2 border rounded-lg mb-3 touch-manipulation">
                <input v-model="productForm.tags" type="text" placeholder="æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰" class="w-full px-4 py-2 border rounded-lg mb-3 touch-manipulation">
                <select v-model="productForm.category_id" class="w-full px-4 py-2 border rounded-lg mb-4 touch-manipulation">
                    <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                </select>
                <div class="flex gap-3">
                    <button @click="showAddProduct = false" class="flex-1 border py-2.5 rounded-lg btn-mobile">å–æ¶ˆ</button>
                    <button @click="addProduct" class="flex-1 bg-indigo-600 text-white py-2.5 rounded-lg btn-mobile">æ·»åŠ </button>
                </div>
            </div>
        </div>

        <!-- Product Detail -->
        <div v-if="selectedProduct" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4" @click.self="selectedProduct = null">
            <div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div v-if="selectedProduct.image_url" class="h-48 sm:h-64 bg-gray-200"><img loading="lazy" :src="selectedProduct.image_url" class="w-full h-full object-cover"></div>
                <div class="p-4 sm:p-6">
                    <div class="flex items-start justify-between">
                        <div><h2 class="text-xl sm:text-2xl font-bold">{{ selectedProduct.name }}</h2><p class="text-sm text-gray-500">{{ formatDate(selectedProduct.created_at) }}</p></div>
                        <button @click="toggleLike(selectedProduct)" class="flex items-center gap-2 px-3 sm:px-4 py-2 rounded-full btn-mobile" :class="selectedProduct.is_liked ? 'bg-red-100 text-red-600' : 'bg-gray-100'">
                            <i class="fas fa-heart" :class="selectedProduct.is_liked ? 'fa-solid' : 'fa-regular'"></i> <span>{{ selectedProduct.like_count }}</span>
                        </button>
                    </div>
                    <p class="mt-4">{{ selectedProduct.description }}</p>
                    <div class="mt-3 flex gap-2 flex-wrap">
                        <span v-for="tag in (selectedProduct.tags || '').split(',').filter(t => t)" :key="tag" class="px-2 py-1 text-xs bg-gray-100 rounded">{{ tag }}</span>
                    </div>
                    <a v-if="selectedProduct.product_url" :href="selectedProduct.product_url" target="_blank" class="mt-4 inline-flex items-center gap-2 text-indigo-600">æŸ¥çœ‹å•†å“ <i class="fas fa-external-link-alt"></i></a>
                    
                    <!-- Share Card -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-500 mb-2">åˆ†äº«</p>
                        <div class="flex gap-2">
                            <button @click="shareWeibo" class="px-3 py-1.5 bg-red-500 text-white rounded text-sm btn-mobile"><i class="fab fa-weibo"></i> å¾®åš</button>
                            <button @click="copyLink" class="px-3 py-1.5 bg-gray-200 rounded text-sm btn-mobile">å¤åˆ¶é“¾æ¥</button>
                        </div>
                    </div>

                    <div class="mt-6 border-t pt-4">
                        <h3 class="font-semibold mb-3">è¯„è®º ({{ comments.length }})</h3>
                        <div v-if="currentUser" class="mb-4 flex gap-2">
                            <input v-model="newComment" @keyup.enter="submitComment" type="text" placeholder="å†™è¯„è®º..." class="flex-1 px-4 py-2 border rounded-lg touch-manipulation">
                            <button @click="submitComment" class="px-4 py-2 bg-indigo-600 text-white rounded-lg btn-mobile">å‘è¡¨</button>
                        </div>
                        <div class="space-y-3">
                            <div v-for="comment in comments" :key="comment.id" class="bg-gray-50 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-medium text-sm">{{ comment.username }}</span>
                                    <span class="text-xs text-gray-400">{{ formatDate(comment.created_at) }}</span>
                                </div>
                                <p>{{ comment.content }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compare Modal -->
        <div v-if="showCompare" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4" @click.self="showCompare = false">
            <div class="bg-white rounded-xl p-4 sm:p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold">äº§å“å¯¹æ¯”</h2><button @click="showCompare = false" class="p-2"><i class="fas fa-times"></i></button></div>
                <div v-if="compareList.length < 2" class="text-center py-8 text-gray-500">è¯·å…ˆæ·»åŠ è‡³å°‘2ä¸ªäº§å“è¿›è¡Œå¯¹æ¯”</div>
                <div v-else class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left p-2">äº§å“</th>
                                <th v-for="p in compareList" :key="p.id" class="p-2">{{ p.name }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b">
                                <td class="p-2 font-medium">å›¾ç‰‡</td>
                                <td v-for="p in compareList" :key="p.id" class="p-2"><img loading="lazy" v-if="p.image_url" :src="p.image_url" class="h-16 w-20 object-cover rounded"></td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-2 font-medium">æè¿°</td>
                                <td v-for="p in compareList" :key="p.id" class="p-2 text-xs">{{ p.description?.slice(0,50) }}...</td>
                            </tr>
                            <tr class="border-b">
                                <td class="p-2 font-medium">ç‚¹èµ</td>
                                <td v-for="p in compareList" :key="p.id" class="p-2"><i class="fas fa-heart text-red-500"></i> {{ p.like_count }}</td>
                            </tr>
                            <tr>
                                <td class="p-2 font-medium">æ“ä½œ</td>
                                <td v-for="p in compareList" :key="p.id" class="p-2"><button @click="viewProduct(p); showCompare = false" class="text-indigo-600 text-xs btn-mobile px-2 py-1">æŸ¥çœ‹è¯¦æƒ…</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Ranking -->
        <div v-if="showRanking" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showRanking = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold"><i class="fas fa-trophy text-yellow-500"></i> æ’è¡Œæ¦œ</h2><button @click="showRanking = false"><i class="fas fa-times"></i></button></div>
                <div class="space-y-3">
                    <div v-for="(user, index) in ranking" :key="user.username" class="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
                        <span class="font-bold" :class="index === 0 ? 'text-yellow-500' : 'text-gray-500'">{{ index + 1 }}</span>
                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">{{ user.username.charAt(0).toUpperCase() }}</div>
                        <div class="flex-1"><div class="font-medium">{{ user.username }}</div><div class="text-xs text-gray-500">{{ user.product_count }} äº§å“ Â· {{ user.like_count }} èµ</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Ranking -->
        <div v-if="showProductRanking" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showProductRanking = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-lg">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold"><i class="fas fa-fire text-red-500"></i> çƒ­é—¨</h2><button @click="showProductRanking = false"><i class="fas fa-times"></i></button></div>
                <select v-model="rankingCategoryId" @change="loadProductRanking" class="w-full px-4 py-2 border rounded-lg mb-4">
                    <option :value="null">å…¨éƒ¨åˆ†ç±»</option>
                    <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                </select>
                <div class="space-y-3">
                    <div v-for="(product, index) in productRanking" :key="product.id" class="flex items-center gap-3 p-3 rounded-lg bg-gray-50" @click="viewProduct(product); showProductRanking = false">
                        <span class="font-bold text-lg" :class="index === 0 ? 'text-yellow-500' : 'text-gray-500'">{{ index + 1 }}</span>
                        <div class="w-12 h-12 rounded-lg bg-gray-200"><img loading="lazy" v-if="product.image_url" :src="product.image_url" class="w-full h-full object-cover rounded-lg"></div>
                        <div class="flex-1"><div class="font-medium">{{ product.name }}</div><div class="text-xs text-gray-500"><i class="fas fa-heart text-red-500"></i> {{ product.like_count }}</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile -->
        <div v-if="showProfile" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showProfile = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-md">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold"><i class="fas fa-user text-indigo-600"></i> ä¸ªäººä¸»é¡µ</h2><button @click="showProfile = false"><i class="fas fa-times"></i></button></div>
                <div class="text-center mb-4">
                    <label class="cursor-pointer">
                        <div class="w-20 h-20 rounded-full bg-indigo-100 flex items-center justify-center text-3xl mx-auto mb-2">{{ currentUser?.charAt(0).toUpperCase() }}</div>
                        <input type="file" @change="handleAvatarUpload" accept="image/*" class="hidden">
                        <span class="text-xs text-indigo-600">æ›´æ¢å¤´åƒ</span>
                    </label>
                </div>
                <div class="flex gap-2 mb-4">
                    <button @click="profileTab = 'products'" class="flex-1 px-4 py-2 rounded-lg" :class="profileTab === 'products' ? 'bg-indigo-600 text-white' : 'bg-gray-100'">æˆ‘çš„äº§å“</button>
                    <button @click="profileTab = 'favorites'" class="flex-1 px-4 py-2 rounded-lg" :class="profileTab === 'favorites' ? 'bg-indigo-600 text-white' : 'bg-gray-100'">æ”¶è—</button>
                </div>
                <div v-if="profileTab === 'products'" class="space-y-3 max-h-60 overflow-y-auto">
                    <div v-for="product in myProducts" :key="product.id" class="flex items-center gap-3 p-2 bg-gray-50 rounded" @click="viewProduct(product); showProfile = false">
                        <div class="w-10 h-10 rounded bg-gray-200"><img loading="lazy" v-if="product.image_url" :src="product.image_url" class="w-full h-full object-cover rounded"></div>
                        <div class="flex-1 text-sm">{{ product.name }}</div>
                    </div>
                </div>
                <div v-if="profileTab === 'favorites'" class="space-y-3 max-h-60 overflow-y-auto">
                    <div v-for="product in myFavorites" :key="product.id" class="flex items-center gap-3 p-2 bg-gray-50 rounded" @click="viewProduct(product); showProfile = false">
                        <div class="w-10 h-10 rounded bg-gray-200"><img loading="lazy" v-if="product.image_url" :src="product.image_url" class="w-full h-full object-cover rounded"></div>
                        <div class="flex-1 text-sm">{{ product.name }}</div>
                        <i class="fas fa-star text-yellow-500"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Picks -->
        <div v-if="showWeekly" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showWeekly = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold"><i class="fas fa-star text-yellow-500"></i> ä¸€å‘¨ç²¾é€‰</h2><button @click="showWeekly = false"><i class="fas fa-times"></i></button></div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div v-for="product in weeklyProducts" :key="product.id" class="bg-gray-50 rounded-lg p-3 cursor-pointer" @click="viewProduct(product); showWeekly = false">
                        <img loading="lazy" v-if="product.image_url" :src="product.image_url" class="w-full h-24 object-cover rounded">
                        <p class="font-medium text-sm mt-2 truncate">{{ product.name }}</p>
                        <p class="text-xs text-gray-500"><i class="fas fa-heart text-red-500"></i> {{ product.like_count }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div v-if="showLeaderboard" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showLeaderboard = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold"><i class="fas fa-chart-line text-green-500"></i> æ´»è·ƒæ¦œ</h2><button @click="showLeaderboard = false"><i class="fas fa-times"></i></button></div>
                <div class="space-y-3">
                    <div v-for="(user, index) in leaderboard" :key="user.user_id" class="flex items-center gap-3 p-3 rounded-lg" :class="index === 0 ? 'bg-yellow-50' : index === 1 ? 'bg-gray-50' : 'bg-gray-50'">
                        <span class="font-bold" :class="index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : 'text-gray-500'">{{ index + 1 }}</span>
                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">{{ user.username?.charAt(0).toUpperCase() }}</div>
                        <div class="flex-1"><div class="font-medium">{{ user.username }}</div><div class="text-xs text-gray-500">{{ user.products }} äº§å“ Â· {{ user.likes }} èµ Â· {{ user.comments }} è¯„è®º</div></div>
                        <span class="font-bold text-indigo-600">{{ user.total }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin -->
        <div v-if="showAdmin" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showAdmin = false">
            <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between mb-4"><h2 class="text-xl font-bold"><i class="fas fa-cog text-indigo-600"></i> ç®¡ç†é¢æ¿</h2><button @click="showAdmin = false"><i class="fas fa-times"></i></button></div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-indigo-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-indigo-600">{{ adminStats.total_users }}</div>
                        <div class="text-sm text-gray-500">ç”¨æˆ·</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600">{{ adminStats.total_products }}</div>
                        <div class="text-sm text-gray-500">äº§å“</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600">{{ adminStats.total_likes }}</div>
                        <div class="text-sm text-gray-500">ç‚¹èµ</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-600">{{ adminStats.total_comments }}</div>
                        <div class="text-sm text-gray-500">è¯„è®º</div>
                    </div>
                </div>
                <h3 class="font-semibold mb-2">çƒ­é—¨äº§å“</h3>
                <div class="space-y-2 mb-4">
                    <div v-for="p in adminStats.top_products" :key="p.id" class="flex items-center gap-2 text-sm">
                        <span class="w-6">{{ p.id }}</span>
                        <span class="flex-1">{{ p.name }}</span>
                        <span class="text-red-500">{{ p.like_count }} èµ</span>
                    </div>
                </div>
                <h3 class="font-semibold mb-2">æœ€æ–°äº§å“</h3>
                <div class="space-y-2">
                    <div v-for="p in adminStats.recent_products" :key="p.id" class="flex items-center gap-2 text-sm">
                        <span class="w-6">{{ p.id }}</span>
                        <span class="flex-1">{{ p.name }}</span>
                        <span class="text-gray-400">{{ formatDate(p.created_at) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    loading: true,
                    currentUser: localStorage.getItem('username') || null,
                    currentUserId: null, isAdmin: false,
                    products: [], categories: [], brands: [], tags: [],
                    comments: [],
                    selectedProduct: null, selectedBrand: null,
                    showLogin: false, showAddProduct: false, showRanking: false, showProductRanking: false, showWeekly: false, showLeaderboard: false, showProfile: false, showAdmin: false, showCompare: false,
                    ranking: [], productRanking: [], myProducts: [], myFavorites: [],
                    adminStats: {},
                    profileTab: 'products', rankingCategoryId: null, isRegister: false,
                    search: '', brandId: null, categoryId: null, sort: 'latest',
                    authForm: { username: '', password: '' },
                    productForm: { name: '', description: '', image_url: '', product_url: '', tags: '', category_id: 1, imagePreview: '' },
                    newComment: '', compareList: []
                }
            },
            mounted() {
                this.loadCategories(); this.loadProducts(); this.loadTags(); this.loadBrands(); this.checkUser();
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('product')) this.loadProductById(urlParams.get('product'));
                if (urlParams.get('brand')) this.loadBrand(parseInt(urlParams.get('brand')));
            },
            methods: {
                async checkUser() {
                    if (!this.currentUser) return;
                    const res = await fetch('/api/user?username=' + this.currentUser);
                    const user = await res.json();
                    if (user) { this.currentUserId = user.id; this.isAdmin = user.is_admin; }
                },
                goHome() { this.selectedBrand = null; this.brandId = null; this.selectedProduct = null; this.categoryId = null; this.search = ''; this.loadProducts(); window.history.pushState({}, '', '/'); },
                async loadCategories() { this.categories = await (await fetch('/api/categories')).json(); },
                async loadTags() { this.tags = await (await fetch('/api/tags')).json(); },
                async loadBrands() { this.brands = await (await fetch('/api/brands')).json(); },
                async loadProducts() {
                    this.loading = true;
                    const params = new URLSearchParams();
                    if (this.categoryId) params.append('category_id', this.categoryId);
                    if (this.brandId) params.append('brand_id', this.brandId);
                    if (this.search) params.append('search', this.search);
                    params.append('sort', this.sort);
                    if (this.currentUser) params.append('username', this.currentUser);
                    this.products = await (await fetch('/api/products?' + params)).json();
                    this.$nextTick(() => {
                        this.loading = false;
                        this.$nextTick(() => {
                            document.querySelectorAll('.product-card').forEach((card, i) => {
                                setTimeout(() => card.classList.add('loaded'), i * 50);
                            });
                        });
                    });
                },
                loadBrandProducts() {
                    if (this.brandId) {
                        this.loading = true;
                        fetch('/api/brands/' + this.brandId).then(r => r.json()).then(b => { 
                            this.selectedBrand = b; 
                            this.products = b.products || [];
                            this.loading = false;
                        });
                    } else { this.selectedBrand = null; this.loadProducts(); }
                },
                async loadBrand(id) {
                    const brand = await (await fetch('/api/brands/' + id)).json();
                    this.selectedBrand = brand;
                    this.products = brand.products || [];
                    window.history.pushState({}, '', '?brand=' + id);
                },
                searchTag(tag) { this.search = tag; this.loadProducts(); },
                async loadProductById(id) {
                    const res = await fetch('/api/products/' + id + '?username=' + (this.currentUser || ''));
                    if (res.ok) { this.selectedProduct = await res.json(); this.loadComments(this.selectedProduct.id); }
                },
                async loadRanking() { this.ranking = await (await fetch('/api/ranking')).json(); },
                async loadProductRanking() {
                    const params = new URLSearchParams();
                    if (this.rankingCategoryId) params.append('category_id', this.rankingCategoryId);
                    this.productRanking = await (await fetch('/api/products/top?' + params)).json();
                },
                async loadUserData() {
                    if (!this.currentUser) return;
                    this.myProducts = await (await fetch('/api/user/products?username=' + this.currentUser)).json();
                    this.myFavorites = await (await fetch('/api/user/favorites?username=' + this.currentUser)).json();
                },
                async loadAdminStats() { this.adminStats = await (await fetch('/api/admin/stats')).json(); },
                async auth() {
                    const endpoint = this.isRegister ? '/api/register' : '/api/login';
                    const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.authForm) });
                    if (!res.ok) { alert((await res.json()).error); return; }
                    const data = await res.json();
                    this.currentUser = data.username; this.currentUserId = data.user_id; this.isAdmin = data.is_admin;
                    localStorage.setItem('username', this.currentUser);
                    this.showLogin = false; this.authForm = { username: '', password: '' }; this.loadProducts();
                },
                logout() { this.currentUser = null; localStorage.removeItem('username'); this.loadProducts(); },
                handleImageUpload(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { this.productForm.imagePreview = e.target.result; this.productForm.image_url = e.target.result; };
                        reader.readAsDataURL(file);
                    }
                },
                handleAvatarUpload(e) {
                    const file = e.target.files[0];
                    if (file && this.currentUser) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            await fetch('/api/user/avatar', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: this.currentUser, avatar: e.target.result }) });
                            alert('å¤´åƒå·²æ›´æ–°');
                        };
                        reader.readAsDataURL(file);
                    }
                },
                async addProduct() {
                    if (!this.currentUser) { alert('è¯·å…ˆç™»å½•'); return; }
                    const res = await fetch('/api/products', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...this.productForm, username: this.currentUser }) });
                    if (res.ok) { this.showAddProduct = false; this.productForm = { name: '', description: '', image_url: '', product_url: '', tags: '', category_id: 1, imagePreview: '' }; this.loadProducts(); this.loadTags(); }
                },
                async viewProduct(product) { this.selectedProduct = { ...product }; await this.loadComments(product.id); window.history.pushState({}, '', '?product=' + product.id); },
                async loadComments(productId) { this.comments = await (await fetch('/api/products/' + productId + '/comments?username=' + (this.currentUser || ''))).json(); },
                async toggleLike(product) {
                    if (!this.currentUser) { this.showLogin = true; return; }
                    product.likeAnimating = true;
                    const res = await fetch('/api/products/' + product.id + '/like', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: this.currentUser }) });
                    const data = await res.json(); product.like_count = data.count; product.is_liked = data.liked;
                    setTimeout(() => product.likeAnimating = false, 300);
                    if (this.selectedProduct && this.selectedProduct.id === product.id) { this.selectedProduct.like_count = data.count; this.selectedProduct.is_liked = data.liked; }
                },
                async toggleFavorite(product) {
                    if (!this.currentUser) { this.showLogin = true; return; }
                    const res = await fetch('/api/products/' + product.id + '/favorite', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: this.currentUser }) });
                    const data = await res.json(); product.is_favorited = data.favorited;
                    if (this.selectedProduct && this.selectedProduct.id === product.id) this.selectedProduct.is_favorited = data.favorited;
                },
                toggleCompare(product) {
                    const idx = this.compareList.findIndex(p => p.id === product.id);
                    if (idx >= 0) this.compareList.splice(idx, 1);
                    else if (this.compareList.length < 4) this.compareList.push(product);
                },
                removeFromCompare(p) { this.compareList = this.compareList.filter(x => x.id !== p.id); },
                async submitComment() {
                    if (!this.newComment.trim()) return;
                    await fetch('/api/comments', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ product_id: this.selectedProduct.id, content: this.newComment, username: this.currentUser }) });
                    this.newComment = ''; this.loadComments(this.selectedProduct.id);
                },
                shareWeibo() {
                    const url = encodeURIComponent(window.location.origin + '?product=' + this.selectedProduct.id);
                    const title = encodeURIComponent(this.selectedProduct.name);
                    window.open('http://service.weibo.com/share/share.php?url=' + url + '&title=' + title, '_blank');
                },
                copyLink() {
                    navigator.clipboard.writeText(window.location.origin + '?product=' + this.selectedProduct.id);
                    alert('é“¾æ¥å·²å¤åˆ¶');
                },
                formatDate(d) { return new Date(d).toLocaleDateString('zh-CN'); }
            }
        }).mount('#app');
    </script>
</body>
